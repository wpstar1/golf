<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2ecc71">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>⛳ 골프 스코어 라이브</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Malgun Gothic', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: manipulation;
        }

        .app {
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            background: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: env(safe-area-inset-top, 20px) 12px 12px;
            padding-top: calc(env(safe-area-inset-top, 20px) + 12px);
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
        }

        .menu-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .tab-bar {
            display: flex;
            background: rgba(0,0,0,0.1);
            border-radius: 20px;
            padding: 3px;
            margin-top: 8px;
        }

        .tab {
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 8px 4px;
            border-radius: 17px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            cursor: pointer;
        }

        .tab.active {
            background: white;
            color: #27ae60;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .screen {
            display: none;
            padding: 12px;
            animation: slideIn 0.3s ease;
            min-height: 100%;
            padding-bottom: calc(60px + env(safe-area-inset-bottom, 0));
        }

        .screen.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .camera-section {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        #video, #canvas, #uploadedImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }

        .camera-placeholder .icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .camera-placeholder p {
            font-size: 0.9rem;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            min-height: 44px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-full {
            grid-column: 1 / -1;
        }

        .score-card {
            background: white;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 12px;
        }

        .course-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-group label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            transition: all 0.3s;
            min-height: 44px;
            width: 100%;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #2ecc71;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .players-list {
            margin-top: 12px;
        }

        .player-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            transition: all 0.3s;
            min-height: 60px;
        }

        .player-card:active {
            transform: scale(0.98);
        }

        .player-rank {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            flex-shrink: 0;
        }

        .player-rank.first {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        .player-info {
            flex: 1;
            min-width: 0;
        }

        .player-name {
            font-weight: 700;
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 4px;
            word-break: keep-all;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-stats {
            display: flex;
            gap: 12px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #999;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-value.under {
            color: #e74c3c;
        }

        .stat-value.even {
            color: #2c3e50;
        }

        .stat-value.over {
            color: #3498db;
        }

        .preview-container {
            position: relative;
            width: 100%;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        #previewCanvas {
            width: 100%;
            display: block;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 8px 0 env(safe-area-inset-bottom, 8px);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 5px;
            border: none;
            background: none;
            color: #999;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 44px;
        }

        .nav-item.active {
            color: #2ecc71;
        }

        .nav-item .icon {
            font-size: 1.3rem;
        }

        .nav-item .label {
            font-size: 0.7rem;
            font-weight: 600;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #uploadInput {
            display: none;
        }

        /* iOS 안전 영역 대응 */
        @supports (padding: max(0px)) {
            .header {
                padding-top: max(20px, env(safe-area-inset-top));
            }

            .bottom-nav {
                padding-bottom: max(8px, env(safe-area-inset-bottom));
            }
        }

        /* 작은 화면 최적화 */
        @media screen and (max-height: 667px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .tab {
                font-size: 0.8rem;
                padding: 6px 4px;
            }

            .btn {
                padding: 10px 6px;
                font-size: 0.85rem;
            }

            .player-card {
                padding: 10px;
                min-height: 55px;
            }
        }

        /* 매우 작은 화면 (SE 등) */
        @media screen and (max-width: 320px) {
            .header h1 {
                font-size: 1.1rem;
            }

            .course-info {
                grid-template-columns: 1fr;
            }

            .btn-group {
                grid-template-columns: 1fr;
            }

            .btn {
                font-size: 0.85rem;
            }
        }

        /* 가로 모드 차단 스타일 */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .app::before {
                content: "📱 세로 모드로 사용해주세요";
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
                font-weight: 600;
                z-index: 9999;
            }
        }

        /* 터치 반응 개선 */
        @media (hover: none) and (pointer: coarse) {
            .btn:active,
            .nav-item:active {
                opacity: 0.8;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="header-top">
                <h1>⛳ 골프 스코어 라이브</h1>
                <button class="menu-btn">⚙️</button>
            </div>
            <div class="tab-bar">
                <button class="tab active" data-screen="camera">📸 카메라</button>
                <button class="tab" data-screen="score">🏌️ 스코어</button>
                <button class="tab" data-screen="preview">📱 미리보기</button>
            </div>
        </div>

        <div class="content">
            <!-- 카메라 스크린 -->
            <div class="screen active" id="camera-screen">
                <div class="camera-section">
                    <div class="camera-container">
                        <video id="video" style="display: none;" playsinline></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <img id="uploadedImage" style="display: none;">
                        <div class="camera-placeholder" id="placeholder">
                            <div class="icon">📷</div>
                            <p>사진을 찍거나 업로드하세요</p>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="startCamera">
                            📹 카메라 시작
                        </button>
                        <button class="btn btn-warning" id="uploadPhoto">
                            📁 사진 선택
                        </button>
                        <button class="btn btn-success btn-full" id="capturePhoto" style="display: none;">
                            📸 사진 찍기
                        </button>
                    </div>
                </div>

                <div class="score-card">
                    <h3 style="margin-bottom: 12px; font-size: 1rem;">🏌️ 클럽 & 코스 정보</h3>
                    <div class="input-group" style="margin-bottom: 12px;">
                        <label>클럽 이름</label>
                        <input type="text" id="clubName" value="꿀잼" placeholder="예: 꿀잼, 버디">
                    </div>
                    <div class="course-info">
                        <div class="input-group">
                            <label>골프장</label>
                            <input type="text" id="courseName" value="제주 나인브릿지">
                        </div>
                        <div class="input-group">
                            <label>현재 홀</label>
                            <select id="holeNumber">
                                <option value="1">1번 홀</option>
                                <option value="2">2번 홀</option>
                                <option value="3">3번 홀</option>
                                <option value="4" selected>4번 홀</option>
                                <option value="5">5번 홀</option>
                                <option value="6">6번 홀</option>
                                <option value="7">7번 홀</option>
                                <option value="8">8번 홀</option>
                                <option value="9">9번 홀</option>
                                <option value="10">10번 홀</option>
                                <option value="11">11번 홀</option>
                                <option value="12">12번 홀</option>
                                <option value="13">13번 홀</option>
                                <option value="14">14번 홀</option>
                                <option value="15">15번 홀</option>
                                <option value="16">16번 홀</option>
                                <option value="17">17번 홀</option>
                                <option value="18">18번 홀</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 스코어 스크린 -->
            <div class="screen" id="score-screen">
                <div class="players-list" id="playersList">
                    <!-- 플레이어 카드들이 여기에 동적으로 추가됨 -->
                </div>
            </div>

            <!-- 미리보기 스크린 -->
            <div class="screen" id="preview-screen">
                <div class="preview-container">
                    <canvas id="previewCanvas"></canvas>
                    <div class="camera-placeholder" id="previewPlaceholder">
                        <div class="icon">🖼️</div>
                        <p>먼저 사진을 촬영해주세요</p>
                    </div>
                </div>

                <div class="score-card">
                    <h3 style="margin-bottom: 8px; font-size: 1rem;">📍 오버레이 배치</h3>
                    <div style="padding: 12px; background: #f0f0f0; border-radius: 8px; font-size: 0.85rem; color: #666; line-height: 1.4;">
                        ✅ 왼쪽 상단: 골프장 이름<br>
                        ✅ 오른쪽 상단: 클럽 이름<br>
                        ✅ 오른쪽 하단: 스코어보드
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" id="downloadBtn">
                        💾 저장
                    </button>
                    <button class="btn btn-primary" id="shareBtn">
                        📤 공유
                    </button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" data-screen="camera">
                <span class="icon">📷</span>
                <span class="label">카메라</span>
            </button>
            <button class="nav-item" data-screen="score">
                <span class="icon">🏌️</span>
                <span class="label">스코어</span>
            </button>
            <button class="nav-item" data-screen="preview">
                <span class="icon">📱</span>
                <span class="label">미리보기</span>
            </button>
            <button class="nav-item" id="quickShare">
                <span class="icon">✨</span>
                <span class="label">빠른공유</span>
            </button>
        </div>
    </div>

    <!-- 로딩 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <input type="file" id="uploadInput" accept="image/*" capture="environment">

    <script>
        // 뷰포트 높이 설정 (iOS 대응)
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);

        // iOS 바운스 스크롤 방지
        document.addEventListener('touchmove', function(e) {
            if (!e.target.closest('.content')) {
                e.preventDefault();
            }
        }, { passive: false });

        // 전역 변수
        let players = [];
        let stream = null;
        let capturedImage = null;
        let overlayPosition = 'bottom-right';
        let currentScreen = 'camera';

        // 자동 저장/로드 기능
        function saveData() {
            const data = {
                players: players,
                clubName: document.getElementById('clubName').value,
                courseName: document.getElementById('courseName').value,
                holeNumber: document.getElementById('holeNumber').value,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('golfScoreData', JSON.stringify(data));
            console.log('데이터 저장됨:', data);
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('golfScoreData');
                if (savedData) {
                    const data = JSON.parse(savedData);

                    // 고정 4명 플레이어 데이터 로드
                    if (data.players && data.players.length === 4) {
                        players = data.players;
                    } else {
                        // 기본 4명 플레이어 데이터
                        players = [
                            { name: '홍길동', score: -2, total: 34 },
                            { name: '김철수', score: 0, total: 36 },
                            { name: '이영희', score: 3, total: 39 },
                            { name: '박민수', score: 5, total: 41 }
                        ];
                    }

                    // 폼 데이터 로드
                    if (data.clubName) document.getElementById('clubName').value = data.clubName;
                    if (data.courseName) document.getElementById('courseName').value = data.courseName;
                    if (data.holeNumber) document.getElementById('holeNumber').value = data.holeNumber;

                    console.log('데이터 로드됨:', data);
                } else {
                    // 처음 사용 시 기본 4명 데이터
                    players = [
                        { name: '홍길동', score: -2, total: 34 },
                        { name: '김철수', score: 0, total: 36 },
                        { name: '이영희', score: 3, total: 39 },
                        { name: '박민수', score: 5, total: 41 }
                    ];
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                // 기본 4명 데이터로 초기화
                players = [
                    { name: '홍길동', score: -2, total: 34 },
                    { name: '김철수', score: 0, total: 36 },
                    { name: '이영희', score: 3, total: 39 },
                    { name: '박민수', score: 5, total: 41 }
                ];
            }
        }

        // DOM 요소
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');

        // 탭 전환
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const screen = tab.dataset.screen;
                switchScreen(screen);

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });

        // 하단 네비게이션
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const screen = item.dataset.screen;
                if (screen) {
                    switchScreen(screen);

                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');

                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                        if (t.dataset.screen === screen) {
                            t.classList.add('active');
                        }
                    });
                }
            });
        });

        // 화면 전환
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`${screen}-screen`).classList.add('active');
            currentScreen = screen;

            if (screen === 'preview') {
                updatePreview();
            }
        }

        // 카메라 시작
        document.getElementById('startCamera').addEventListener('click', async () => {
            const btn = document.getElementById('startCamera');

            if (stream) {
                // 카메라 중지
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.style.display = 'none';
                document.getElementById('placeholder').style.display = 'flex';
                document.getElementById('capturePhoto').style.display = 'none';
                btn.innerHTML = '📹 카메라 시작';
            } else {
                // 카메라 시작
                try {
                    const constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };

                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    video.style.display = 'block';
                    document.getElementById('placeholder').style.display = 'none';
                    document.getElementById('capturePhoto').style.display = 'block';
                    btn.innerHTML = '🔴 카메라 중지';

                    video.addEventListener('loadedmetadata', () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                    });
                } catch (err) {
                    console.error('카메라 오류:', err);
                    alert('카메라를 시작할 수 없습니다.\n카메라 권한을 확인해주세요.');
                }
            }
        });

        // 사진 촬영
        document.getElementById('capturePhoto').addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            capturedImage = new Image();
            capturedImage.src = canvas.toDataURL('image/jpeg', 0.9);
            capturedImage.onload = () => {
                canvas.style.display = 'block';
                video.style.display = 'none';
                document.getElementById('capturePhoto').style.display = 'none';
                document.getElementById('placeholder').style.display = 'none';
                updatePreview();

                // 카메라 중지
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                    document.getElementById('startCamera').innerHTML = '📹 카메라 시작';
                }
            };
        });

        // 사진 업로드
        document.getElementById('uploadPhoto').addEventListener('click', () => {
            document.getElementById('uploadInput').click();
        });

        document.getElementById('uploadInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    capturedImage = new Image();
                    capturedImage.onload = () => {
                        canvas.width = capturedImage.width;
                        canvas.height = capturedImage.height;
                        ctx.drawImage(capturedImage, 0, 0);
                        canvas.style.display = 'block';
                        document.getElementById('placeholder').style.display = 'none';
                        document.getElementById('uploadedImage').src = e.target.result;
                        updatePreview();
                    };
                    capturedImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 플레이어 리스트 업데이트
        function updatePlayersList() {
            const container = document.getElementById('playersList');
            container.innerHTML = '';

            players.sort((a, b) => a.score - b.score);

            players.forEach((player, index) => {
                const scoreClass = player.score < 0 ? 'under' : player.score > 0 ? 'over' : 'even';
                const scoreText = player.score > 0 ? `+${player.score}` : player.score === 0 ? 'E' : `${player.score}`;

                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `
                    <div class="player-rank ${index === 0 ? 'first' : ''}">${index + 1}</div>
                    <div class="player-info">
                        <div class="player-name" contenteditable="true" data-field="name" data-index="${index}">${player.name}</div>
                        <div class="player-stats">
                            <div class="stat">
                                <div class="stat-label">스코어</div>
                                <div class="stat-value ${scoreClass}" contenteditable="true" data-field="score" data-index="${index}">${scoreText}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">총타수</div>
                                <div class="stat-value" contenteditable="true" data-field="total" data-index="${index}">${player.total}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);

                // 이름과 스코어 편집 가능
                const editableElements = card.querySelectorAll('[contenteditable="true"]');
                editableElements.forEach(element => {
                    element.addEventListener('blur', handlePlayerEdit);
                    element.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            element.blur();
                        }
                    });
                });
            });
        }

        // 플레이어 정보 편집 처리
        function handlePlayerEdit(event) {
            const element = event.target;
            const field = element.dataset.field;
            const index = parseInt(element.dataset.index);
            let value = element.textContent.trim();

            if (field === 'name') {
                // 이름 수정
                if (value && value.length <= 10) {
                    players[index].name = value;
                    updatePlayersList();
                    updatePreview();
                    saveData();
                } else {
                    updatePlayersList();
                }
            } else if (field === 'score') {
                // 스코어 파싱
                let scoreValue;
                if (value.toLowerCase() === 'e') {
                    scoreValue = 0;
                } else {
                    scoreValue = parseInt(value.replace(/[^-\d]/g, ''));
                }

                if (!isNaN(scoreValue) && scoreValue >= -10 && scoreValue <= 15) {
                    players[index].score = scoreValue;
                    const currentHole = parseInt(document.getElementById('holeNumber').value);
                    const basePar = 72;
                    const estimatedTotal = basePar + scoreValue;
                    players[index].total = Math.max(18, estimatedTotal);

                    updatePlayersList();
                    updatePreview();
                    saveData();
                } else {
                    updatePlayersList();
                }
            } else if (field === 'total') {
                // 총타수 수정
                const totalValue = parseInt(value);
                if (!isNaN(totalValue) && totalValue >= 18 && totalValue <= 150) {
                    players[index].total = totalValue;
                    updatePlayersList();
                    updatePreview();
                    saveData();
                } else {
                    updatePlayersList();
                }
            }
        }

        // 미리보기 업데이트
        function updatePreview() {
            if (!capturedImage) {
                document.getElementById('previewPlaceholder').style.display = 'flex';
                previewCanvas.style.display = 'none';
                return;
            }

            document.getElementById('previewPlaceholder').style.display = 'none';
            previewCanvas.style.display = 'block';

            previewCanvas.width = capturedImage.width;
            previewCanvas.height = capturedImage.height;

            previewCtx.drawImage(capturedImage, 0, 0);
            drawOverlay(previewCtx, previewCanvas.width, previewCanvas.height);
        }

        // 오버레이 그리기 (모바일 최적화)
        function drawOverlay(ctx, canvasWidth, canvasHeight) {
            const scale = Math.min(canvasWidth, canvasHeight) / 1000;
            const padding = 15 * scale;

            // 현재 시간
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

            // 1. 상단 중앙 - 홀 번호와 시간 (모바일 최적화 크기)
            const holeNumber = document.getElementById('holeNumber').value;
            const topBarWidth = 260 * scale;
            const topBarHeight = 60 * scale;
            const topBarX = (canvasWidth - topBarWidth) / 2;
            const topBarY = padding;

            // 상단 바 배경
            const topGradient = ctx.createLinearGradient(topBarX, topBarY, topBarX, topBarY + topBarHeight);
            topGradient.addColorStop(0, 'rgba(15, 76, 129, 0.95)');
            topGradient.addColorStop(0.5, 'rgba(9, 132, 227, 0.9)');
            topGradient.addColorStop(1, 'rgba(30, 144, 255, 0.95)');
            ctx.fillStyle = topGradient;
            roundRect(ctx, topBarX, topBarY, topBarWidth, topBarHeight, 6 * scale);
            ctx.fill();

            // 상단 바 테두리
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1.5 * scale;
            roundRect(ctx, topBarX, topBarY, topBarWidth, topBarHeight, 6 * scale);
            ctx.stroke();

            // PAR 4 표시
            ctx.fillStyle = 'white';
            ctx.font = `bold ${14 * scale}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText('PAR 4', topBarX + topBarWidth/2, topBarY + 18 * scale);

            // 홀 번호
            ctx.font = `bold ${28 * scale}px Arial`;
            ctx.fillText(holeNumber, topBarX + 50 * scale, topBarY + 42 * scale);

            // 시간
            ctx.font = `${12 * scale}px Arial`;
            ctx.fillText(timeString, topBarX + topBarWidth - 50 * scale, topBarY + 22 * scale);

            // 날짜
            const dateString = now.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'long' });
            ctx.font = `${10 * scale}px Arial`;
            ctx.fillText(dateString, topBarX + topBarWidth - 50 * scale, topBarY + 38 * scale);

            // 2. 왼쪽 상단 - 골프장 이름
            const courseName = document.getElementById('courseName').value;
            if (courseName) {
                const courseWidth = 220 * scale;
                const courseHeight = 45 * scale;
                const courseX = padding;
                const courseY = padding;

                // 배경
                const courseGradient = ctx.createLinearGradient(courseX, courseY, courseX, courseY + courseHeight);
                courseGradient.addColorStop(0, 'rgba(0, 0, 0, 0.85)');
                courseGradient.addColorStop(1, 'rgba(0, 0, 0, 0.75)');
                ctx.fillStyle = courseGradient;
                roundRect(ctx, courseX, courseY, courseWidth, courseHeight, 6 * scale);
                ctx.fill();

                // 테두리
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1.5 * scale;
                roundRect(ctx, courseX, courseY, courseWidth, courseHeight, 6 * scale);
                ctx.stroke();

                // 텍스트
                ctx.fillStyle = 'white';
                ctx.font = `bold ${16 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(courseName, courseX + courseWidth/2, courseY + 28 * scale);
            }

            // 3. 오른쪽 상단 - 클럽 이름
            const clubName = document.getElementById('clubName').value;
            if (clubName) {
                const clubWidth = 160 * scale;
                const clubHeight = 45 * scale;
                const clubX = canvasWidth - clubWidth - padding;
                const clubY = padding;

                // 클럽 배경
                const clubGradient = ctx.createLinearGradient(clubX, clubY, clubX, clubY + clubHeight);
                clubGradient.addColorStop(0, '#4CAF50');
                clubGradient.addColorStop(0.5, '#388E3C');
                clubGradient.addColorStop(1, '#2E7D32');
                ctx.fillStyle = clubGradient;
                roundRect(ctx, clubX, clubY, clubWidth, clubHeight, 6 * scale);
                ctx.fill();

                // 테두리
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1.5 * scale;
                roundRect(ctx, clubX, clubY, clubWidth, clubHeight, 6 * scale);
                ctx.stroke();

                // 클럽 텍스트
                ctx.fillStyle = 'white';
                ctx.font = `bold ${18 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(clubName, clubX + clubWidth/2, clubY + 28 * scale);
            }

            // 4. 오른쪽 하단 - 모바일 최적화 스코어보드
            const scoreWidth = 340 * scale;
            const headerHeight = 40 * scale;
            const rowHeight = 40 * scale;
            const scoreHeight = headerHeight + (players.length * rowHeight) + 8 * scale;
            const scoreX = canvasWidth - scoreWidth - padding;
            const scoreY = canvasHeight - scoreHeight - padding;

            // 메인 스코어보드 배경
            ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
            roundRect(ctx, scoreX, scoreY, scoreWidth, scoreHeight, 10 * scale);
            ctx.fill();

            // 헤더 배경
            const headerGradient = ctx.createLinearGradient(scoreX, scoreY, scoreX, scoreY + headerHeight);
            headerGradient.addColorStop(0, '#1565C0');
            headerGradient.addColorStop(0.5, '#1976D2');
            headerGradient.addColorStop(1, '#1E88E5');
            ctx.fillStyle = headerGradient;
            roundRect(ctx, scoreX, scoreY, scoreWidth, headerHeight, [10 * scale, 10 * scale, 0, 0]);
            ctx.fill();

            // 헤더 구분선
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1 * scale;
            ctx.beginPath();
            ctx.moveTo(scoreX + 45 * scale, scoreY + 8 * scale);
            ctx.lineTo(scoreX + 45 * scale, scoreY + headerHeight - 8 * scale);
            ctx.moveTo(scoreX + 180 * scale, scoreY + 8 * scale);
            ctx.lineTo(scoreX + 180 * scale, scoreY + headerHeight - 8 * scale);
            ctx.moveTo(scoreX + 250 * scale, scoreY + 8 * scale);
            ctx.lineTo(scoreX + 250 * scale, scoreY + headerHeight - 8 * scale);
            ctx.stroke();

            // 헤더 텍스트
            ctx.fillStyle = 'white';
            ctx.font = `bold ${12 * scale}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText('#', scoreX + 22 * scale, scoreY + 25 * scale);
            ctx.fillText('PLAYER', scoreX + 112 * scale, scoreY + 25 * scale);
            ctx.fillText('SPT', scoreX + 215 * scale, scoreY + 25 * scale);
            ctx.fillText('TOTAL', scoreX + 295 * scale, scoreY + 25 * scale);

            // 플레이어 행들
            players.forEach((player, index) => {
                const playerY = scoreY + headerHeight + (index * rowHeight);
                const isLeader = index === 0;

                // 행 배경
                if (isLeader) {
                    const leaderGradient = ctx.createLinearGradient(scoreX, playerY, scoreX, playerY + rowHeight);
                    leaderGradient.addColorStop(0, 'rgba(255, 193, 7, 0.2)');
                    leaderGradient.addColorStop(1, 'rgba(255, 235, 59, 0.1)');
                    ctx.fillStyle = leaderGradient;
                } else {
                    ctx.fillStyle = index % 2 === 1 ? 'rgba(255, 255, 255, 0.05)' : 'transparent';
                }
                ctx.fillRect(scoreX, playerY, scoreWidth, rowHeight);

                // 행 구분선
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1 * scale;
                ctx.beginPath();
                ctx.moveTo(scoreX + 45 * scale, playerY);
                ctx.lineTo(scoreX + 45 * scale, playerY + rowHeight);
                ctx.moveTo(scoreX + 180 * scale, playerY);
                ctx.lineTo(scoreX + 180 * scale, playerY + rowHeight);
                ctx.moveTo(scoreX + 250 * scale, playerY);
                ctx.lineTo(scoreX + 250 * scale, playerY + rowHeight);
                ctx.stroke();

                // 순위
                const rankCircleSize = 20 * scale;
                ctx.fillStyle = isLeader ? '#FFD700' : '#64B5F6';
                ctx.beginPath();
                ctx.arc(scoreX + 22 * scale, playerY + rowHeight/2, rankCircleSize/2, 0, Math.PI * 2);
                ctx.fill();

                // 순위 숫자
                ctx.fillStyle = isLeader ? '#000' : 'white';
                ctx.font = `bold ${14 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(`${index + 1}`, scoreX + 22 * scale, playerY + rowHeight/2 + 4 * scale);

                // 플레이어 이름
                ctx.fillStyle = 'white';
                ctx.font = `bold ${16 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(player.name, scoreX + 112 * scale, playerY + rowHeight/2 + 5 * scale);

                // 스코어
                const scoreText = player.score > 0 ? `+${player.score}` : player.score === 0 ? 'E' : `${player.score}`;
                ctx.fillStyle = player.score < 0 ? '#4CAF50' : player.score > 0 ? '#F44336' : '#FFF';
                ctx.font = `bold ${18 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(scoreText, scoreX + 215 * scale, playerY + rowHeight/2 + 5 * scale);

                // 총타수
                ctx.fillStyle = 'white';
                ctx.font = `bold ${18 * scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(player.total, scoreX + 295 * scale, playerY + rowHeight/2 + 5 * scale);
            });

            // 스코어보드 하단 브랜딩
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.font = `${10 * scale}px Arial`;
            ctx.textAlign = 'right';
            ctx.fillText('LIVE', scoreX + scoreWidth - 8 * scale, scoreY + scoreHeight - 6 * scale);
        }

        // RoundRect 헬퍼 함수
        function roundRect(ctx, x, y, width, height, radius) {
            if (typeof radius === 'number') {
                radius = [radius, radius, radius, radius];
            } else if (Array.isArray(radius) && radius.length === 2) {
                radius = [radius[0], radius[0], radius[1], radius[1]];
            }

            ctx.beginPath();
            ctx.moveTo(x + radius[0], y);
            ctx.lineTo(x + width - radius[1], y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius[1]);
            ctx.lineTo(x + width, y + height - radius[2]);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius[2], y + height);
            ctx.lineTo(x + radius[3], y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius[3]);
            ctx.lineTo(x, y + radius[0]);
            ctx.quadraticCurveTo(x, y, x + radius[0], y);
            ctx.closePath();
        }

        // 다운로드
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!capturedImage) {
                alert('먼저 사진을 촬영해주세요!');
                return;
            }

            try {
                updatePreview();

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
                const filename = `golf_score_${timestamp}.jpg`;

                previewCanvas.toBlob((blob) => {
                    if (blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        alert(`이미지가 저장되었습니다: ${filename}`);
                    } else {
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = previewCanvas.toDataURL('image/jpeg', 0.95);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        alert(`이미지가 저장되었습니다: ${filename}`);
                    }
                }, 'image/jpeg', 0.95);
            } catch (error) {
                console.error('저장 오류:', error);
                alert('저장 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        });

        // 공유
        document.getElementById('shareBtn').addEventListener('click', async () => {
            if (!capturedImage) {
                alert('먼저 사진을 촬영해주세요!');
                return;
            }

            try {
                previewCanvas.toBlob(async (blob) => {
                    if (navigator.share && navigator.canShare) {
                        const file = new File([blob], 'golf_score.jpg', { type: 'image/jpeg' });
                        const shareData = {
                            files: [file],
                            title: '골프 스코어',
                            text: '골프 라운딩 실시간 스코어'
                        };

                        if (navigator.canShare(shareData)) {
                            await navigator.share(shareData);
                        } else {
                            copyToClipboard(blob);
                        }
                    } else {
                        copyToClipboard(blob);
                    }
                }, 'image/jpeg', 0.9);
            } catch (err) {
                alert('공유 실패: ' + err.message);
            }
        });

        // 클립보드 복사
        async function copyToClipboard(blob) {
            try {
                const item = new ClipboardItem({ 'image/png': blob });
                await navigator.clipboard.write([item]);
                alert('이미지가 복사되었습니다!\n카톡에서 붙여넣기하세요.');
            } catch (err) {
                alert('복사 실패: ' + err.message);
            }
        }

        // 빠른 공유
        document.getElementById('quickShare').addEventListener('click', () => {
            if (!capturedImage) {
                alert('먼저 사진을 촬영해주세요!');
                switchScreen('camera');
                return;
            }

            document.getElementById('loading').classList.add('active');

            setTimeout(() => {
                updatePreview();
                document.getElementById('shareBtn').click();
                document.getElementById('loading').classList.remove('active');
            }, 500);
        });

        // 초기화
        loadData();
        updatePlayersList();

        // 코스 정보 변경 시 업데이트
        document.getElementById('clubName').addEventListener('input', () => {
            updatePreview();
            saveData();
        });
        document.getElementById('courseName').addEventListener('input', () => {
            updatePreview();
            saveData();
        });
        document.getElementById('holeNumber').addEventListener('change', () => {
            updatePreview();
            saveData();
        });

        // PWA 설치 프롬프트
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Service Worker 등록
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(registration => {
                console.log('Service Worker registered:', registration);
            }).catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>
</body>
</html>